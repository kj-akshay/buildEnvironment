<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- Copyright Â© 1988-2025 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "Funding Free Software", the Front-Cover
Texts being (a) (see below), and with the Back-Cover Texts being (b)
(see below).  A copy of the license is included in the section entitled
"GNU Free Documentation License".

(a) The FSF's Front-Cover Text is:

A GNU Manual

(b) The FSF's Back-Cover Text is:

You have freedom to copy and modify this GNU Manual, like GNU
     software.  Copies published by the Free Software Foundation raise
     funds for GNU development. -->
<title>Mode Switching (GNU Compiler Collection (GCC) Internals)</title>

<meta name="description" content="Mode Switching (GNU Compiler Collection (GCC) Internals)">
<meta name="keywords" content="Mode Switching (GNU Compiler Collection (GCC) Internals)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Option-Index.html" rel="index" title="Option Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Target-Macros.html" rel="up" title="Target Macros">
<link href="Target-Attributes.html" rel="next" title="Target Attributes">
<link href="Floating-Point.html" rel="prev" title="Floating Point">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
span:hover a.copiable-link {visibility: visible}
strong.def-name {font-family: monospace; font-weight: bold; font-size: larger}
-->
</style>


</head>

<body lang="en">
<div class="section-level-extent" id="Mode-Switching">
<div class="nav-panel">
<p>
Next: <a href="Target-Attributes.html" accesskey="n" rel="next">Defining target-specific uses of <code class="code">__attribute__</code></a>, Previous: <a href="Floating-Point.html" accesskey="p" rel="prev">Cross Compilation and Floating Point</a>, Up: <a href="Target-Macros.html" accesskey="u" rel="up">Target Description Macros and Functions</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Option-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h3 class="section" id="Mode-Switching-Instructions"><span>17.23 Mode Switching Instructions<a class="copiable-link" href="#Mode-Switching-Instructions"> &para;</a></span></h3>
<a class="index-entry-id" id="index-mode-switching"></a>
<p>The following macros control mode switching optimizations:
</p>
<dl class="first-deffn first-defmac-alias-first-deffn">
<dt class="deffn defmac-alias-deffn" id="index-OPTIMIZE_005fMODE_005fSWITCHING"><span class="category-def">Macro: </span><span><strong class="def-name">OPTIMIZE_MODE_SWITCHING</strong> <var class="def-var-arguments">(<var class="var">entity</var>)</var><a class="copiable-link" href="#index-OPTIMIZE_005fMODE_005fSWITCHING"> &para;</a></span></dt>
<dd><p>Define this macro if the port needs extra instructions inserted for mode
switching.
</p>
<p>For an example, the SH4 can perform both single and double precision
floating point operations, but to perform a single precision operation,
the FPSCR PR bit has to be cleared, while for a double precision
operation, this bit has to be set.  Changing the PR bit requires a general
purpose register as a scratch register, hence these FPSCR sets have to
be inserted before reload, i.e. you cannot put this into instruction emitting
or <code class="code">TARGET_MACHINE_DEPENDENT_REORG</code>.
</p>
<p>You can have multiple entities that are mode-switched, some of which might
only be needed conditionally.  The entities are identified by their index
into the <code class="code">NUM_MODES_FOR_MODE_SWITCHING</code> initializer, with the length
of the initializer determining the number of entities.
</p>
<p><code class="code">OPTIMIZE_MODE_SWITCHING</code> should return nonzero for any <var class="var">entity</var>
that needs mode-switching.
</p>
<p>If you define this macro, you also have to define
<code class="code">NUM_MODES_FOR_MODE_SWITCHING</code>, <code class="code">TARGET_MODE_NEEDED</code>,
<code class="code">TARGET_MODE_PRIORITY</code> and <code class="code">TARGET_MODE_EMIT</code>.
The other macros in this section are optional.
</p></dd></dl>

<dl class="first-deffn first-defmac-alias-first-deffn">
<dt class="deffn defmac-alias-deffn" id="index-NUM_005fMODES_005fFOR_005fMODE_005fSWITCHING"><span class="category-def">Macro: </span><span><strong class="def-name">NUM_MODES_FOR_MODE_SWITCHING</strong><a class="copiable-link" href="#index-NUM_005fMODES_005fFOR_005fMODE_005fSWITCHING"> &para;</a></span></dt>
<dd><p>If you define <code class="code">OPTIMIZE_MODE_SWITCHING</code>, you have to define this as
initializer for an array of integers.  Each initializer element
N refers to an entity that needs mode switching, and specifies the number
of different modes that are defined for that entity.
The position of the element in the initializer&mdash;starting counting at
zero&mdash;determines the integer that is used to refer to the mode-switched
entity in question.
Modes are represented as numbers 0 &hellip; N &minus; 1.
In mode arguments and return values, N either represents an unknown
mode or &ldquo;no mode&rdquo;, depending on context.
</p></dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-TARGET_005fMODE_005fEMIT"><span class="category-def">Target Hook: </span><span><code class="def-type">void</code> <strong class="def-name">TARGET_MODE_EMIT</strong> <code class="def-code-arguments">(int <var class="var">entity</var>, int <var class="var">mode</var>, int <var class="var">prev_mode</var>, HARD_REG_SET <var class="var">regs_live</var>)</code><a class="copiable-link" href="#index-TARGET_005fMODE_005fEMIT"> &para;</a></span></dt>
<dd><p>Generate one or more insns to set <var class="var">entity</var> to <var class="var">mode</var>.
<var class="var">hard_reg_live</var> is the set of hard registers live at the point where
the insn(s) are to be inserted. <var class="var">prev_moxde</var> indicates the mode
to switch from, or is the number of modes if the previous mode is not
known.  Sets of a lower numbered entity will be emitted before
sets of a higher numbered entity to a mode of the same or lower priority.
</p></dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-TARGET_005fMODE_005fNEEDED"><span class="category-def">Target Hook: </span><span><code class="def-type">int</code> <strong class="def-name">TARGET_MODE_NEEDED</strong> <code class="def-code-arguments">(int <var class="var">entity</var>, rtx_insn *<var class="var">insn</var>, HARD_REG_SET <var class="var">regs_live</var>)</code><a class="copiable-link" href="#index-TARGET_005fMODE_005fNEEDED"> &para;</a></span></dt>
<dd><p><var class="var">entity</var> is an integer specifying a mode-switched entity.
If <code class="code">OPTIMIZE_MODE_SWITCHING</code> is defined, you must define this hook
to return the mode that <var class="var">entity</var> must be switched into prior to the
execution of <var class="var">insn</var>, or the number of modes if <var class="var">insn</var> has no
such requirement.  <var class="var">regs_live</var> contains the set of hard registers
that are live before <var class="var">insn</var>.
</p></dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-TARGET_005fMODE_005fAFTER"><span class="category-def">Target Hook: </span><span><code class="def-type">int</code> <strong class="def-name">TARGET_MODE_AFTER</strong> <code class="def-code-arguments">(int <var class="var">entity</var>, int <var class="var">mode</var>, rtx_insn *<var class="var">insn</var>, HARD_REG_SET <var class="var">regs_live</var>)</code><a class="copiable-link" href="#index-TARGET_005fMODE_005fAFTER"> &para;</a></span></dt>
<dd><p><var class="var">entity</var> is an integer specifying a mode-switched entity.
If this hook is defined, it is evaluated for every <var class="var">insn</var> during mode
switching.  It returns the mode that <var class="var">entity</var> is in after <var class="var">insn</var>
has been executed.  <var class="var">mode</var> is the mode that <var class="var">entity</var> was in
before <var class="var">insn</var> was executed, taking account of <var class="var">TARGET_MODE_NEEDED</var>.
<var class="var">regs_live</var> is the set of hard registers that are live after <var class="var">insn</var>
has been executed.
</p>
<p><var class="var">mode</var> is equal to the number of modes defined for <var class="var">entity</var>
if the mode before <var class="var">insn</var> is unknown.  The hook should likewise return
the number of modes if it does not know what mode <var class="var">entity</var> has after
<var class="var">insn</var>.
</p>
<p>Not defining the hook is equivalent to returning <var class="var">mode</var>.
</p></dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-TARGET_005fMODE_005fCONFLUENCE"><span class="category-def">Target Hook: </span><span><code class="def-type">int</code> <strong class="def-name">TARGET_MODE_CONFLUENCE</strong> <code class="def-code-arguments">(int <var class="var">entity</var>, int <var class="var">mode1</var>, int <var class="var">mode2</var>)</code><a class="copiable-link" href="#index-TARGET_005fMODE_005fCONFLUENCE"> &para;</a></span></dt>
<dd><p>By default, the mode-switching pass assumes that a given entity&rsquo;s modes
are mutually exclusive.  This means that the pass can only tell
<code class="code">TARGET_MODE_EMIT</code> about an entity&rsquo;s previous mode if all
incoming paths of execution leave the entity in the same state.
</p>
<p>However, some entities might have overlapping, non-exclusive modes,
so that it is sometimes possible to represent &ldquo;mode <var class="var">mode1</var> or mode
<var class="var">mode2</var>&rdquo; with something more specific than &ldquo;mode not known&rdquo;.
If this is true for at least one entity, you should define this hook
and make it return a mode that includes <var class="var">mode1</var> and <var class="var">mode2</var>
as possibilities.  (The mode can include other possibilities too.)
The hook should return the number of modes if no suitable mode exists
for the given arguments.
</p></dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-TARGET_005fMODE_005fBACKPROP"><span class="category-def">Target Hook: </span><span><code class="def-type">int</code> <strong class="def-name">TARGET_MODE_BACKPROP</strong> <code class="def-code-arguments">(int <var class="var">entity</var>, int <var class="var">mode1</var>, int <var class="var">mode2</var>)</code><a class="copiable-link" href="#index-TARGET_005fMODE_005fBACKPROP"> &para;</a></span></dt>
<dd><p>If defined, the mode-switching pass uses this hook to back-propagate mode
requirements through blocks that have no mode requirements of their own.
Specifically, <var class="var">mode1</var> is the mode that <var class="var">entity</var> has on exit
from a block B1 (say) and <var class="var">mode2</var> is the mode that the next block
requires <var class="var">entity</var> to have.  B1 does not have any mode requirements
of its own.
</p>
<p>The hook should return the mode that it prefers or requires <var class="var">entity</var>
to have in B1, or the number of modes if there is no such requirement.
If the hook returns a required mode for more than one of B1&rsquo;s outgoing
edges, those modes are combined as for <code class="code">TARGET_MODE_CONFLUENCE</code>.
</p>
<p>For example, suppose there is a &ldquo;one-shot&rdquo; entity that,
for a given execution of a function, either stays off or makes exactly
one transition from off to on.  It is safe to make the transition at any
time, but it is better not to do so unnecessarily.  This hook allows the
function to manage such an entity without having to track its state at
runtime.  Specifically. the entity would have two modes, 0 for off and
1 for on, with 2 representing &ldquo;don&rsquo;t know&rdquo;.  The system is forbidden from
transitioning from 2 to 1, since 2 represents the possibility that the
entity is already on (and the aim is to avoid having to emit code to
check for that case).  This hook would therefore return 1 when <var class="var">mode1</var>
is 2 and <var class="var">mode2</var> is 1, which would force the entity to be on in the
source block.  Applying this inductively would remove all transitions
in which the previous state is unknown.
</p></dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-TARGET_005fMODE_005fENTRY"><span class="category-def">Target Hook: </span><span><code class="def-type">int</code> <strong class="def-name">TARGET_MODE_ENTRY</strong> <code class="def-code-arguments">(int <var class="var">entity</var>)</code><a class="copiable-link" href="#index-TARGET_005fMODE_005fENTRY"> &para;</a></span></dt>
<dd><p>If this hook is defined, it is evaluated for every <var class="var">entity</var> that
needs mode switching.  It should return the mode that <var class="var">entity</var> is
guaranteed to be in on entry to the function, or the number of modes
if there is no such guarantee.
If <code class="code">TARGET_MODE_ENTRY</code> is defined then <code class="code">TARGET_MODE_EXIT</code>
must be defined.
</p></dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-TARGET_005fMODE_005fEXIT"><span class="category-def">Target Hook: </span><span><code class="def-type">int</code> <strong class="def-name">TARGET_MODE_EXIT</strong> <code class="def-code-arguments">(int <var class="var">entity</var>)</code><a class="copiable-link" href="#index-TARGET_005fMODE_005fEXIT"> &para;</a></span></dt>
<dd><p>If this hook is defined, it is evaluated for every <var class="var">entity</var> that
needs mode switching.  It should return the mode that <var class="var">entity</var> must
be in on return from the function, or the number of modes if there is no
such requirement.
If <code class="code">TARGET_MODE_EXIT</code> is defined then <code class="code">TARGET_MODE_ENTRY</code>
must be defined.
</p></dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-TARGET_005fMODE_005fEH_005fHANDLER"><span class="category-def">Target Hook: </span><span><code class="def-type">int</code> <strong class="def-name">TARGET_MODE_EH_HANDLER</strong> <code class="def-code-arguments">(int <var class="var">entity</var>)</code><a class="copiable-link" href="#index-TARGET_005fMODE_005fEH_005fHANDLER"> &para;</a></span></dt>
<dd><p>If this hook is defined, it should return the mode that <var class="var">entity</var> is
guaranteed to be in on entry to an exception handler, or the number of modes
if there is no such guarantee.
</p></dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-TARGET_005fMODE_005fPRIORITY"><span class="category-def">Target Hook: </span><span><code class="def-type">int</code> <strong class="def-name">TARGET_MODE_PRIORITY</strong> <code class="def-code-arguments">(int <var class="var">entity</var>, int <var class="var">n</var>)</code><a class="copiable-link" href="#index-TARGET_005fMODE_005fPRIORITY"> &para;</a></span></dt>
<dd><p>This hook specifies the order in which modes for <var class="var">entity</var>
are processed. 0 is the highest priority,
<code class="code">NUM_MODES_FOR_MODE_SWITCHING[<var class="var">entity</var>] - 1</code> the lowest.
The hook returns an integer designating a mode
for <var class="var">entity</var>.  For any fixed <var class="var">entity</var>, <code class="code">mode_priority</code>
(<var class="var">entity</var>, <var class="var">n</var>) shall be a bijection in 0 &hellip;
<code class="code">num_modes_for_mode_switching[<var class="var">entity</var>] - 1</code>.
</p></dd></dl>

</div>
<hr>
<div class="nav-panel">
<p>
Next: <a href="Target-Attributes.html">Defining target-specific uses of <code class="code">__attribute__</code></a>, Previous: <a href="Floating-Point.html">Cross Compilation and Floating Point</a>, Up: <a href="Target-Macros.html">Target Description Macros and Functions</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Option-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
