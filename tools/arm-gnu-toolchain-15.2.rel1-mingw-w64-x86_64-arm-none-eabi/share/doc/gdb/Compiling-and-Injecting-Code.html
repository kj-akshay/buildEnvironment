<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- Copyright © 1988-2024 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "Free Software" and "Free Software Needs
Free Documentation", with the Front-Cover Texts being "A GNU Manual,"
and with the Back-Cover Texts as in (a) below.

(a) The FSF's Back-Cover Text is: "You are free to copy and modify
this GNU Manual.  Buying copies from GNU Press supports the FSF in
developing GNU and promoting software freedom." -->
<title>Compiling and Injecting Code (Debugging with GDB)</title>

<meta name="description" content="Compiling and Injecting Code (Debugging with GDB)">
<meta name="keywords" content="Compiling and Injecting Code (Debugging with GDB)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Concept-Index.html" rel="index" title="Concept Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Altering.html" rel="up" title="Altering">
<link href="Patching.html" rel="prev" title="Patching">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
span:hover a.copiable-link {visibility: visible}
-->
</style>


</head>

<body lang="en">
<div class="section-level-extent" id="Compiling-and-Injecting-Code">
<div class="nav-panel">
<p>
Previous: <a href="Patching.html" accesskey="p" rel="prev">Patching Programs</a>, Up: <a href="Altering.html" accesskey="u" rel="up">Altering Execution</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Concept-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h3 class="section" id="Compiling-and-injecting-code-in-gdb"><span>17.7 Compiling and injecting code in <small class="sc">GDB</small><a class="copiable-link" href="#Compiling-and-injecting-code-in-gdb"> &para;</a></span></h3>
<a class="index-entry-id" id="index-injecting-code"></a>
<a class="index-entry-id" id="index-writing-into-executables-1"></a>
<a class="index-entry-id" id="index-compiling-code"></a>

<p><small class="sc">GDB</small> supports on-demand compilation and code injection into
programs running under <small class="sc">GDB</small>.  GCC 5.0 or higher built with
<samp class="file">libcc1.so</samp> must be installed for this functionality to be enabled.
This functionality is implemented with the following commands.
</p>
<dl class="table">
<dt><a id="index-compile-code"></a><span><code class="code">compile code <var class="var">source-code</var></code><a class="copiable-link" href="#index-compile-code"> &para;</a></span></dt>
<dt><code class="code">compile code -raw <var class="var">--</var> <var class="var">source-code</var></code></dt>
<dd><p>Compile <var class="var">source-code</var> with the compiler language found as the current
language in <small class="sc">GDB</small> (see <a class="pxref" href="Languages.html">Using <small class="sc">GDB</small> with Different Languages</a>).  If compilation and
injection is not supported with the current language specified in
<small class="sc">GDB</small>, or the compiler does not support this feature, an error
message will be printed.  If <var class="var">source-code</var> compiles and links
successfully, <small class="sc">GDB</small> will load the object-code emitted,
and execute it within the context of the currently selected inferior.
It is important to note that the compiled code is executed immediately.
After execution, the compiled code is removed from <small class="sc">GDB</small> and any
new types or variables you have defined will be deleted.
</p>
<p>The command allows you to specify <var class="var">source-code</var> in two ways.
The simplest method is to provide a single line of code to the command.
E.g.:
</p>
<div class="example smallexample">
<pre class="example-preformatted">compile code printf (&quot;hello world\n&quot;);
</pre></div>

<p>If you specify options on the command line as well as source code, they
may conflict.  The &lsquo;<samp class="samp">--</samp>&rsquo; delimiter can be used to separate options
from actual source code.  E.g.:
</p>
<div class="example smallexample">
<pre class="example-preformatted">compile code -r -- printf (&quot;hello world\n&quot;);
</pre></div>

<p>Alternatively you can enter source code as multiple lines of text.  To
enter this mode, invoke the &lsquo;<samp class="samp">compile code</samp>&rsquo; command without any text
following the command.  This will start the multiple-line editor and
allow you to type as many lines of source code as required.  When you
have completed typing, enter &lsquo;<samp class="samp">end</samp>&rsquo; on its own line to exit the
editor.
</p>
<div class="example smallexample">
<pre class="example-preformatted">compile code
&gt;printf (&quot;hello\n&quot;);
&gt;printf (&quot;world\n&quot;);
&gt;end
</pre></div>

<p>Specifying &lsquo;<samp class="samp">-raw</samp>&rsquo;, prohibits <small class="sc">GDB</small> from wrapping the
provided <var class="var">source-code</var> in a callable scope.  In this case, you must
specify the entry point of the code by defining a function named
<code class="code">_gdb_expr_</code>.  The &lsquo;<samp class="samp">-raw</samp>&rsquo; code cannot access variables of the
inferior.  Using &lsquo;<samp class="samp">-raw</samp>&rsquo; option may be needed for example when
<var class="var">source-code</var> requires &lsquo;<samp class="samp">#include</samp>&rsquo; lines which may conflict with
inferior symbols otherwise.
</p>
</dd>
<dt><a id="index-compile-file"></a><span><code class="code">compile file <var class="var">filename</var></code><a class="copiable-link" href="#index-compile-file"> &para;</a></span></dt>
<dt><code class="code">compile file -raw <var class="var">filename</var></code></dt>
<dd><p>Like <code class="code">compile code</code>, but take the source code from <var class="var">filename</var>.
</p>
<div class="example smallexample">
<pre class="example-preformatted">compile file /home/user/example.c
</pre></div>

<p>The <var class="var">filename</var> argument supports escaping and quoting, see
<a class="ref" href="Filename-Arguments.html">Filenames As Command Arguments</a>.
</p></dd>
</dl>

<dl class="table">
<dt><code class="code">compile print [[<var class="var">options</var>] --] <var class="var">expr</var></code></dt>
<dt><code class="code">compile print [[<var class="var">options</var>] --] /<var class="var">f</var> <var class="var">expr</var></code></dt>
<dd><p>Compile and execute <var class="var">expr</var> with the compiler language found as the
current language in <small class="sc">GDB</small> (see <a class="pxref" href="Languages.html">Using <small class="sc">GDB</small> with Different Languages</a>).  By default the
value of <var class="var">expr</var> is printed in a format appropriate to its data type;
you can choose a different format by specifying &lsquo;<samp class="samp">/<var class="var">f</var></samp>&rsquo;, where
<var class="var">f</var> is a letter specifying the format; see <a class="ref" href="Output-Formats.html">Output
Formats</a>.  The <code class="code">compile print</code> command accepts the same options
as the <code class="code">print</code> command; see <a class="ref" href="Data.html#print-options">print options</a>.
</p>
</dd>
<dt><a id="index-reprint-the-last-value-1"></a><span><code class="code">compile print [[<var class="var">options</var>] --]</code><a class="copiable-link" href="#index-reprint-the-last-value-1"> &para;</a></span></dt>
<dt><code class="code">compile print [[<var class="var">options</var>] --] /<var class="var">f</var></code></dt>
<dd><p>Alternatively you can enter the expression (source code producing it) as
multiple lines of text.  To enter this mode, invoke the &lsquo;<samp class="samp">compile print</samp>&rsquo;
command without any text following the command.  This will start the
multiple-line editor.
</p></dd>
</dl>

<p>The process of compiling and injecting the code can be inspected using:
</p>
<dl class="table">
<dd><a class="anchor" id="set-debug-compile"></a></dd>
<dt><a id="index-compile-command-debugging-info"></a><span><code class="code">set debug compile</code><a class="copiable-link" href="#index-compile-command-debugging-info"> &para;</a></span></dt>
<dd><p>Turns on or off display of <small class="sc">GDB</small> process of compiling and
injecting the code.  The default is off.
</p>
</dd>
<dt><code class="code">show debug compile</code></dt>
<dd><p>Displays the current state of displaying <small class="sc">GDB</small> process of
compiling and injecting the code.
</p>
<a class="anchor" id="set-debug-compile_002dcplus_002dtypes"></a></dd>
<dt><a id="index-compile-C_002b_002b-type-conversion"></a><span><code class="code">set debug compile-cplus-types</code><a class="copiable-link" href="#index-compile-C_002b_002b-type-conversion"> &para;</a></span></dt>
<dd><p>Turns on or off the display of C<code class="t">++</code> type conversion debugging information.
The default is off.
</p>
</dd>
<dt><code class="code">show debug compile-cplus-types</code></dt>
<dd><p>Displays the current state of displaying debugging information for
C<code class="t">++</code> type conversion.
</p></dd>
</dl>

<ul class="mini-toc">
<li><a href="#Compilation-options-for-the-compile-command" accesskey="1">Compilation options for the <code class="code">compile</code> command</a></li>
<li><a href="#Caveats-when-using-the-compile-command" accesskey="2">Caveats when using the <code class="code">compile</code> command</a></li>
<li><a href="#Compiler-search-for-the-compile-command" accesskey="3">Compiler search for the <code class="code">compile</code> command</a></li>
</ul>
<div class="subsection-level-extent" id="Compilation-options-for-the-compile-command">
<h4 class="subsection"><span>17.7.1 Compilation options for the <code class="code">compile</code> command<a class="copiable-link" href="#Compilation-options-for-the-compile-command"> &para;</a></span></h4>

<p><small class="sc">GDB</small> needs to specify the right compilation options for the code
to be injected, in part to make its ABI compatible with the inferior
and in part to make the injected code compatible with <small class="sc">GDB</small>&rsquo;s
injecting process.
</p>
<p>The options used, in increasing precedence:
</p>
<dl class="table">
<dt>target architecture and OS options (<code class="code">gdbarch</code>)</dt>
<dd><p>These options depend on target processor type and target operating
system, usually they specify at least 32-bit (<code class="code">-m32</code>) or 64-bit
(<code class="code">-m64</code>) compilation option.
</p>
</dd>
<dt>compilation options recorded in the target</dt>
<dd><p><small class="sc">GCC</small> (since version 4.7) stores the options used for compilation
into <code class="code">DW_AT_producer</code> part of DWARF debugging information according
to the <small class="sc">GCC</small> option <code class="code">-grecord-gcc-switches</code>.  One has to
explicitly specify <code class="code">-g</code> during inferior compilation otherwise
<small class="sc">GCC</small> produces no DWARF.  This feature is only relevant for
platforms where <code class="code">-g</code> produces DWARF by default, otherwise one may
try to enforce DWARF by using <code class="code">-gdwarf-4</code>.
</p>
</dd>
<dt>compilation options set by <code class="code">set compile-args</code></dt>
</dl>

<p>You can override compilation options using the following command:
</p>
<dl class="table">
<dt><a id="index-compile-command-options-override"></a><span><code class="code">set compile-args</code><a class="copiable-link" href="#index-compile-command-options-override"> &para;</a></span></dt>
<dd><p>Set compilation options used for compiling and injecting code with the
<code class="code">compile</code> commands.  These options override any conflicting ones
from the target architecture and/or options stored during inferior
compilation.
</p>
</dd>
<dt><code class="code">show compile-args</code></dt>
<dd><p>Displays the current state of compilation options override.
This does not show all the options actually used during compilation,
use <a class="ref" href="#set-debug-compile">set debug compile</a> for that.
</p></dd>
</dl>

</div>
<div class="subsection-level-extent" id="Caveats-when-using-the-compile-command">
<h4 class="subsection"><span>17.7.2 Caveats when using the <code class="code">compile</code> command<a class="copiable-link" href="#Caveats-when-using-the-compile-command"> &para;</a></span></h4>

<p>There are a few caveats to keep in mind when using the <code class="code">compile</code>
command.  As the caveats are different per language, the table below
highlights specific issues on a per language basis.
</p>
<dl class="table">
<dt>C code examples and caveats</dt>
<dd><p>When the language in <small class="sc">GDB</small> is set to &lsquo;<samp class="samp">C</samp>&rsquo;, the compiler will
attempt to compile the source code with a &lsquo;<samp class="samp">C</samp>&rsquo; compiler.  The source
code provided to the <code class="code">compile</code> command will have much the same
access to variables and types as it normally would if it were part of
the program currently being debugged in <small class="sc">GDB</small>.
</p>
<p>Below is a sample program that forms the basis of the examples that
follow.  This program has been compiled and loaded into <small class="sc">GDB</small>,
much like any other normal debugging session.
</p>
<div class="example smallexample">
<pre class="example-preformatted">void function1 (void)
{
   int i = 42;
   printf (&quot;function 1\n&quot;);
}

void function2 (void)
{
   int j = 12;
   function1 ();
}

int main(void)
{
   int k = 6;
   int *p;
   function2 ();
   return 0;
}
</pre></div>

<p>For the purposes of the examples in this section, the program above has
been compiled, loaded into <small class="sc">GDB</small>, stopped at the function
<code class="code">main</code>, and <small class="sc">GDB</small> is awaiting input from the user.
</p>
<p>To access variables and types for any program in <small class="sc">GDB</small>, the
program must be compiled and packaged with debug information.  The
<code class="code">compile</code> command is not an exception to this rule.  Without debug
information, you can still use the <code class="code">compile</code> command, but you will
be very limited in what variables and types you can access.
</p>
<p>So with that in mind, the example above has been compiled with debug
information enabled.  The <code class="code">compile</code> command will have access to
all variables and types (except those that may have been optimized
out).  Currently, as <small class="sc">GDB</small> has stopped the program in the
<code class="code">main</code> function, the <code class="code">compile</code> command would have access to
the variable <code class="code">k</code>.  You could invoke the <code class="code">compile</code> command
and type some source code to set the value of <code class="code">k</code>.  You can also
read it, or do anything with that variable you would normally do in
<code class="code">C</code>.  Be aware that changes to inferior variables in the
<code class="code">compile</code> command are persistent.  In the following example:
</p>
<div class="example smallexample">
<pre class="example-preformatted">compile code k = 3;
</pre></div>

<p>the variable <code class="code">k</code> is now 3.  It will retain that value until
something else in the example program changes it, or another
<code class="code">compile</code> command changes it.
</p>
<p>Normal scope and access rules apply to source code compiled and
injected by the <code class="code">compile</code> command.  In the example, the variables
<code class="code">j</code> and <code class="code">k</code> are not accessible yet, because the program is
currently stopped in the <code class="code">main</code> function, where these variables
are not in scope.  Therefore, the following command
</p>
<div class="example smallexample">
<pre class="example-preformatted">compile code j = 3;
</pre></div>

<p>will result in a compilation error message.
</p>
<p>Once the program is continued, execution will bring these variables in
scope, and they will become accessible; then the code you specify via
the <code class="code">compile</code> command will be able to access them.
</p>
<p>You can create variables and types with the <code class="code">compile</code> command as
part of your source code.  Variables and types that are created as part
of the <code class="code">compile</code> command are not visible to the rest of the program for
the duration of its run.  This example is valid:
</p>
<div class="example smallexample">
<pre class="example-preformatted">compile code int ff = 5; printf (&quot;ff is %d\n&quot;, ff);
</pre></div>

<p>However, if you were to type the following into <small class="sc">GDB</small> after that
command has completed:
</p>
<div class="example smallexample">
<pre class="example-preformatted">compile code printf (&quot;ff is %d\n'', ff);
</pre></div>

<p>a compiler error would be raised as the variable <code class="code">ff</code> no longer
exists.  Object code generated and injected by the <code class="code">compile</code>
command is removed when its execution ends.  Caution is advised
when assigning to program variables values of variables created by the
code submitted to the <code class="code">compile</code> command.  This example is valid:
</p>
<div class="example smallexample">
<pre class="example-preformatted">compile code int ff = 5; k = ff;
</pre></div>

<p>The value of the variable <code class="code">ff</code> is assigned to <code class="code">k</code>.  The variable
<code class="code">k</code> does not require the existence of <code class="code">ff</code> to maintain the value
it has been assigned.  However, pointers require particular care in
assignment.  If the source code compiled with the <code class="code">compile</code> command
changed the address of a pointer in the example program, perhaps to a
variable created in the <code class="code">compile</code> command, that pointer would point
to an invalid location when the command exits.  The following example
would likely cause issues with your debugged program:
</p>
<div class="example smallexample">
<pre class="example-preformatted">compile code int ff = 5; p = &amp;ff;
</pre></div>

<p>In this example, <code class="code">p</code> would point to <code class="code">ff</code> when the
<code class="code">compile</code> command is executing the source code provided to it.
However, as variables in the (example) program persist with their
assigned values, the variable <code class="code">p</code> would point to an invalid
location when the command exists.  A general rule should be followed
in that you should either assign <code class="code">NULL</code> to any assigned pointers,
or restore a valid location to the pointer before the command exits.
</p>
<p>Similar caution must be exercised with any structs, unions, and typedefs
defined in <code class="code">compile</code> command.  Types defined in the <code class="code">compile</code>
command will no longer be available in the next <code class="code">compile</code> command.
Therefore, if you cast a variable to a type defined in the
<code class="code">compile</code> command, care must be taken to ensure that any future
need to resolve the type can be achieved.
</p>
<div class="example smallexample">
<pre class="example-preformatted">(gdb) compile code static struct a { int a; } v = { 42 }; argv = &amp;v;
(gdb) compile code printf (&quot;%d\n&quot;, ((struct a *) argv)-&gt;a);
gdb command line:1:36: error: dereferencing pointer to incomplete type ‘struct a’
Compilation failed.
(gdb) compile code struct a { int a; }; printf (&quot;%d\n&quot;, ((struct a *) argv)-&gt;a);
42
</pre></div>

<p>Variables that have been optimized away by the compiler are not
accessible to the code submitted to the <code class="code">compile</code> command.
Access to those variables will generate a compiler error which <small class="sc">GDB</small>
will print to the console.
</p></dd>
</dl>

</div>
<div class="subsection-level-extent" id="Compiler-search-for-the-compile-command">
<h4 class="subsection"><span>17.7.3 Compiler search for the <code class="code">compile</code> command<a class="copiable-link" href="#Compiler-search-for-the-compile-command"> &para;</a></span></h4>

<p><small class="sc">GDB</small> needs to find <small class="sc">GCC</small> for the inferior being debugged
which may not be obvious for remote targets of different architecture
than where <small class="sc">GDB</small> is running.  Environment variable <code class="env">PATH</code> on
<small class="sc">GDB</small> host is searched for <small class="sc">GCC</small> binary matching the
target architecture and operating system.  This search can be overridden
by <code class="code">set compile-gcc</code> <small class="sc">GDB</small> command below.  <code class="env">PATH</code> is
taken from shell that executed <small class="sc">GDB</small>, it is not the value set by
<small class="sc">GDB</small> command <code class="code">set environment</code>).  See <a class="xref" href="Environment.html">Your Program&rsquo;s Environment</a>.
</p>

<p>Specifically <code class="env">PATH</code> is searched for binaries matching regular expression
<code class="code"><var class="var">arch</var>(-[^-]*)?-<var class="var">os</var>-gcc</code> according to the inferior target being
debugged.  <var class="var">arch</var> is processor name &mdash; multiarch is supported, so for
example both <code class="code">i386</code> and <code class="code">x86_64</code> targets look for pattern
<code class="code">(x86_64|i.86)</code> and both <code class="code">s390</code> and <code class="code">s390x</code> targets look
for pattern <code class="code">s390x?</code>.  <var class="var">os</var> is currently supported only for
pattern <code class="code">linux(-gnu)?</code>.
</p>
<p>On Posix hosts the compiler driver <small class="sc">GDB</small> needs to find also
shared library <samp class="file">libcc1.so</samp> from the compiler.  It is searched in
default shared library search path (overridable with usual environment
variable <code class="env">LD_LIBRARY_PATH</code>), unrelated to <code class="env">PATH</code> or <code class="code">set
compile-gcc</code> settings.  Contrary to it <samp class="file">libcc1plugin.so</samp> is found
according to the installation of the found compiler &mdash; as possibly
specified by the <code class="code">set compile-gcc</code> command.
</p>
<dl class="table">
<dt><a id="index-compile-command-driver-filename-override"></a><span><code class="code">set compile-gcc</code><a class="copiable-link" href="#index-compile-command-driver-filename-override"> &para;</a></span></dt>
<dd><p>Set compilation command used for compiling and injecting code with the
<code class="code">compile</code> commands.  If this option is not set (it is set to
an empty string), the search described above will occur &mdash; that is the
default.
</p>
</dd>
<dt><code class="code">show compile-gcc</code></dt>
<dd><p>Displays the current compile command <small class="sc">GCC</small> driver filename.
If set, it is the main command <code class="command">gcc</code>, found usually for example
under name <samp class="file">x86_64-linux-gnu-gcc</samp>.
</p></dd>
</dl>

</div>
</div>
<hr>
<div class="nav-panel">
<p>
Previous: <a href="Patching.html">Patching Programs</a>, Up: <a href="Altering.html">Altering Execution</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Concept-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
